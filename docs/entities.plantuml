@startuml

title Сущности
hide empty methods

' Common types

enum Actor {
  bot
  user
  system
}

' Entities

package "Task entity" <<Frame>> {
  enum TaskStatus {
    todo
    in_progress
    blocked
    done
  }

  enum TaskSource {
    user
    ai
    system
    template
    import
  }

  class Task {
    +id: UUID
    +created_at: timestamp
    +updated_at: timestamp
    +parent_id: UUID? <<FK Task.id>>
    +title: string
    +status: TaskStatus
    +actor: Actor
    +source: TaskSource
  }

  Task "0..1" --> "0..*" Task : parent_id
  Task --> TaskStatus : status
  Task -up-> Actor : actor
  Task --> TaskSource : source

  note bottom of Task
    Invariants:
    - updated_at >= created_at
    - parent_id exists if set
    - parent_id != id if set
    - title is not empty
    - status, actor, and source are valid
  end note
}

package "TaskDialogEvent entity" <<Frame>> {
  enum TaskDialogEventType {
    task_proposed
    task_accepted
    task_started
    task_progress
    task_refused
    task_done
  }

  class TaskDialogEvent {
    +id: UUID
    +created_at: timestamp
    +task_id: UUID <<FK Task.id>>
    +type: TaskDialogEventType
    +actor: Actor
  }

  TaskDialogEvent "0..*" -right-> "1" Task : task_id
  TaskDialogEvent --> TaskDialogEventType : type
  TaskDialogEvent -up-> Actor : actor

  note bottom of TaskDialogEvent
    Invariants:
    - append-only
    - task_id exists
    - type and actor are valid
  end note
}

package "UserStateEvent entity" <<Frame>> {
  enum UserState {
    work
    household
    rest
    sleep
    unavailable
  }

  class UserStateEvent {
    +id: UUID
    +created_at: timestamp
    +state: UserState
    +actor: Actor
  }

  UserStateEvent --> UserState : state
  UserStateEvent -up-> Actor : actor

  note bottom of UserStateEvent
    Invariants:
    - append-only
    - state and actor are valid
  end note
}

@enduml

@startuml

hide empty methods

' Enums

enum Actor {
  bot
  user
  system
}

enum TaskStatus {
  todo
  in_progress
  blocked
  done
}

enum TaskSource {
  user
  ai
  system
  template
  import
}

enum TaskDialogEventType {
  task_proposed
  task_accepted
  task_started
  task_progress
  task_refused
  task_done
}

enum UserState {
  work
  household
  rest
  sleep
  unavailable
}

' Classes

class Task {
  +id: UUID
  +created_at: timestamp
  +updated_at: timestamp
  +parent_id: UUID? <<FK Task.id>>
  +title: string
  +status: TaskStatus
  +actor: Actor
  +source: TaskSource
}

class TaskDialogEvent {
  +id: UUID
  +created_at: timestamp
  +task_id: UUID <<FK Task.id>>
  +type: TaskDialogEventType
  +actor: Actor
}

class UserStateEvent {
  +id: UUID
  +created_at: timestamp
  +state: UserState
  +actor: Actor
}

' Relationships

Task "0..*" <-- "0..1" Task : parent_id
Task "1" <-- "0..*" TaskDialogEvent : task_id
Actor <-- Task : actor
Actor <-- TaskDialogEvent : actor
Actor <-- UserStateEvent : actor
TaskStatus <-- Task : status
TaskSource <-- Task : source
TaskDialogEventType <-- TaskDialogEvent : type
UserState <-- UserStateEvent : state

' Notes

note bottom of Task
  Invariants:
  - updated_at >= created_at
  - parent_id exists if set
  - parent_id != id if set
  - title is not empty
  - status, actor, and source are valid
end note

note bottom of TaskDialogEvent
  Invariants:
  - append-only
  - task_id exists
  - type and actor are valid
end note

note bottom of UserStateEvent
  Invariants:
  - append-only
  - state and actor are valid
end note

@enduml
